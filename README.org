#+title: stafforini.el
#+author: Pablo Stafforini

Emacs commands for building and previewing the [[https://github.com/benthamite/stafforini.com][stafforini.com]] Hugo site.

* Overview

This package wraps the project's Python and shell build scripts, running them asynchronously via =compile= so output appears in a compilation buffer with proper error highlighting. See =PUBLISHING.md= in the Hugo repo for additional details.

* Workflows

There are two tiers of commands: *interactive export* for single-file edits during day-to-day work, and *batch commands* for bulk operations. You rarely need both at once.

** Day-to-day editing

For routine single-file changes, use ox-hugo's interactive export. Hugo's live reload picks up the new markdown automatically — no =stafforini.el= commands needed.

*** Editing a note

1. Edit the org file.
2. Export with =C-c C-e H H= (current subtree).
3. Hugo live reload picks it up.

*** Editing a quote

1. Edit the =:public:= subtree in the bibliographic note.
2. Export with =C-c C-e H A= (all subtrees).
3. Hugo live reload picks it up.

** Targeted updates

Use these when you've changed a specific upstream source /without/ editing org content. Each command updates only what it needs to.

- *Changed a BibTeX entry* → =M-x stafforini-update-works=. Regenerates work pages from BibTeX data. Auto-restarts the server (Hugo doesn't track shortcode cross-references, so live reload won't propagate BibTeX changes to citing pages).

- *Changed links between notes* → =M-x stafforini-update-backlinks=. Regenerates backlink data from the org-roam database. Auto-restarts the server.

- *Created a new org note file* → =M-x stafforini-prepare-notes=. Adds ox-hugo metadata (=:EXPORT_FILE_NAME:=, =:EXPORT_HUGO_SECTION:=, etc.) to new files that don't have it yet. Run /before/ exporting.

- *Added or changed PDFs* → =M-x stafforini-process-pdfs=. Strips annotations and generates first-page thumbnails.

- *Search index out of date* → =M-x stafforini-rebuild-search-index=. Rebuilds the Pagefind index. Useful after content changes when you want to test search locally without a full rebuild.

** Batch export

Use these after mass edits, migrations, or whenever you want to ensure everything is in sync. Each export command handles its full pipeline automatically — no need to run intermediate scripts.

- =M-x stafforini-export-all-notes= — exports all org notes, then runs inject-lastmod, generate-backlinks, and generate-citing-notes.
- =M-x stafforini-export-all-quotes= — generates the ID→slug map, exports all org quotes, then generates work pages and topic pages.

After batch exporting, restart the server with =M-x stafforini-start-server= to pick up all changes.

** Full rebuild

=M-x stafforini-full-rebuild= — runs the entire pipeline from scratch (7 steps: prepare notes → export notes → export quotes → process PDFs → clean public → hugo build → pagefind index). Use after major structural changes, or as a final check before deploying. Overkill for day-to-day work.

** Deploying

1. Run the needed export/update steps.
2. =M-x stafforini-start-server= to verify locally.
3. =M-x stafforini-deploy=.

** Server management

- =M-x stafforini-start-server= — starts (or restarts) the Hugo dev server. Always kills any existing server first to ensure a fresh build.
- =M-x stafforini-stop-server= — stops the server.

*** When to restart the server

- *Same page changed* → live reload works, no restart needed.
- *Change affects other pages* (BibTeX, backlinks, work pages, citing-notes) → restart with =M-x stafforini-start-server=. The standalone =update-works= and =update-backlinks= commands do this automatically.

* Commands

| Command                              | Description                                            |
|--------------------------------------+--------------------------------------------------------|
| =M-x stafforini-prepare-notes=      | Add ox-hugo metadata to new org note files             |
| =M-x stafforini-export-all-notes=   | Export notes + inject lastmod, backlinks, citing-notes |
| =M-x stafforini-export-all-quotes=  | ID-slug map + export quotes + work pages, topic pages  |
| =M-x stafforini-update-works=       | Generate/update work pages from BibTeX data            |
| =M-x stafforini-update-backlinks=   | Regenerate backlink data from org-roam                 |
| =M-x stafforini-process-pdfs=       | Strip annotations from PDFs and generate thumbnails    |
| =M-x stafforini-start-server=       | Start Hugo dev server (always restarts for fresh data) |
| =M-x stafforini-stop-server=        | Stop the Hugo dev server                               |
| =M-x stafforini-rebuild-search-index= | Rebuild the Pagefind search index                    |
| =M-x stafforini-full-rebuild=       | Run the full pipeline sequentially (7 steps)           |
| =M-x stafforini-deploy=            | Build and deploy to Netlify                            |
| =M-x stafforini-insert-image=       | Insert an image with AI-generated filename and alt text |
